<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.gstatic.com https://*.firebaseio.com https://*.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.gstatic.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com;">
    <title>لوحة تحكم - Queen Beauty</title>
    
    <!-- Firebase Modular SDK -->
    <script type="module" id="firebase-sdk-module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, addDoc, increment, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        window.firebaseModules = {
            initializeApp, getAuth, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence,
            getFirestore, doc, collection, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, increment, limit,
            getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable
        };
        console.log("✅ Firebase Modules Loaded in Admin");
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css-security.css">
    <style>
        :root {
            --admin-sidebar-width: 250px;
            --admin-header-height: 70px;
        }
        body { font-family: 'Cairo', sans-serif; background-color: #f4f7f6; margin: 0; overflow-x: hidden; }
        .admin-header { height: var(--admin-header-height); background: white; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .header-logo { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.2rem; }
        .header-logo img { height: 40px; }
        .admin-container { display: flex; flex-direction: column; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; }
        .admin-tab { padding: 10px 20px; border: none; background: white; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; display: flex; align-items: center; gap: 8px; transition: all 0.3s; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .admin-tab.active { background: var(--primary-color, #1c1c1c); color: white; }
        .admin-tab-content { display: none; animation: fadeIn 0.3s ease; }
        .admin-tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .admin-stat-card { background: white; padding: 20px; border-radius: 12px; display: flex; align-items: center; gap: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .stat-icon { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .stat-icon.users { background: #e3f2fd; color: #2196f3; }
        .stat-icon.products { background: #f3e5f5; color: #9c27b0; }
        .stat-icon.orders { background: #e8f5e9; color: #4caf50; }
        .stat-icon.sales { background: #fff3e0; color: #ff9800; }
        .stat-details h3 { margin: 0; font-size: 1.5rem; }
        .stat-details p { margin: 0; color: #666; font-size: 0.9rem; }
        .admin-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .tab-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .add-product-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; }
        .logout-admin-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-pending { color: #f39c12; }
        .status-delivered { color: #27ae60; }
        .status-cancelled { color: #e74c3c; }
        .action-btn { border: none; background: none; cursor: pointer; padding: 5px; font-size: 1.1rem; transition: transform 0.2s; }
        .action-btn:hover { transform: scale(1.2); }
        .btn-edit { color: #3498db; }
        .btn-delete { color: #e74c3c; }
        /* Modal Styles */
        .admin-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .admin-modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo'; }
        .image-preview { width: 100%; height: 200px; border: 2px dashed #ddd; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; margin-top: 10px; overflow: hidden; }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="anti-screenshot">
    <!-- Header -->
    <header class="admin-header">
        <div class="header-logo">
            <img src="https://i.ibb.co/fVn1SghC/file-00000000cf8071f498fc71b66e09f615.png" alt="Logo">
            <span>لوحة التحكم الآمنة</span>
        </div>
        <div class="header-actions" style="display: flex; gap: 10px; align-items: center;">
            <button class="admin-tab" onclick="window.location.href='index.html'" style="border: 1px solid #ddd; background: white;">
                <i class="fas fa-external-link-alt"></i> المتجر
            </button>
            <button onclick="handleLogout()" class="logout-admin-btn">
                <i class="fas fa-sign-out-alt"></i> خروج
            </button>
        </div>
    </header>

    <div class="admin-container">
        <!-- Tabs -->
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="dashboard">
                <i class="fas fa-chart-line"></i> الإحصائيات
            </button>
            <button class="admin-tab" data-tab="productsManagement">
                <i class="fas fa-boxes"></i> المنتجات
            </button>
            <button class="admin-tab" data-tab="ordersManagement">
                <i class="fas fa-shopping-cart"></i> الطلبات
            </button>
            <button class="admin-tab" data-tab="usersManagement">
                <i class="fas fa-users"></i> المستخدمين
            </button>
            <button class="admin-tab" data-tab="settingsManagement">
                <i class="fas fa-cog"></i> الإعدادات
            </button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="admin-tab-content active">
            <div class="admin-stats">
                <div class="admin-stat-card">
                    <div class="stat-icon users"><i class="fas fa-users"></i></div>
                    <div class="stat-details">
                        <h3 id="statUsers">0</h3>
                        <p>المستخدمين</p>
                    </div>
                </div>
                <div class="admin-stat-card">
                    <div class="stat-icon products"><i class="fas fa-box"></i></div>
                    <div class="stat-details">
                        <h3 id="statProducts">0</h3>
                        <p>المنتجات</p>
                    </div>
                </div>
                <div class="admin-stat-card">
                    <div class="stat-icon orders"><i class="fas fa-shopping-cart"></i></div>
                    <div class="stat-details">
                        <h3 id="statOrders">0</h3>
                        <p>الطلبات المكتملة</p>
                    </div>
                </div>
                <div class="admin-stat-card">
                    <div class="stat-icon sales"><i class="fas fa-dollar-sign"></i></div>
                    <div class="stat-details">
                        <h3 id="statSales">0 SDG</h3>
                        <p>إجمالي المبيعات</p>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <h3><i class="fas fa-history"></i> الطلبات الأخيرة</h3>
                <div id="recentOrdersList">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Products Management -->
        <div class="admin-tab-content" id="productsManagement">
            <div class="tab-header">
                <h3>إدارة المنتجات</h3>
                <button class="add-product-btn" onclick="openProductModal()">
                    <i class="fas fa-plus"></i> إضافة منتج
                </button>
            </div>
            <div class="admin-card">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: right; border-bottom: 2px solid #eee;">
                            <th style="padding: 10px;">الصورة</th>
                            <th style="padding: 10px;">الاسم</th>
                            <th style="padding: 10px;">الفئة</th>
                            <th style="padding: 10px;">السعر</th>
                            <th style="padding: 10px;">المخزون</th>
                            <th style="padding: 10px;">الحالة</th>
                            <th style="padding: 10px;">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="adminProductsTableBody">
                        <!-- JS content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Orders Management -->
        <div class="admin-tab-content" id="ordersManagement">
            <div class="tab-header">
                <h3>إدارة الطلبات</h3>
                <select id="orderStatusFilter" class="form-control" style="width: 200px;" onchange="loadAdminOrders(this.value)">
                    <option value="all">جميع الحالات</option>
                    <option value="pending">قيد الانتظار</option>
                    <option value="processing">جاري التجهيز</option>
                    <option value="shipped">تم الشحن</option>
                    <option value="delivered">تم التوصيل</option>
                    <option value="cancelled">ملغي</option>
                </select>
            </div>
            <div id="adminOrdersContainer">
                <!-- JS content -->
            </div>
        </div>

        <!-- Users Management -->
        <div class="admin-tab-content" id="usersManagement">
            <h3>إدارة المستخدمين</h3>
            <div id="adminUsersContainer" class="admin-card">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: right; border-bottom: 2px solid #eee;">
                            <th style="padding: 10px;">الاسم</th>
                            <th style="padding: 10px;">البريد</th>
                            <th style="padding: 10px;">الهاتف</th>
                            <th style="padding: 10px;">الرتبة</th>
                            <th style="padding: 10px;">تاريخ الانضمام</th>
                            <th style="padding: 10px;">إجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="adminUsersTableBody">
                        <!-- JS content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings -->
        <div class="admin-tab-content" id="settingsManagement">
            <h3>إعدادات الموقع</h3>
            <div class="admin-card">
                <div id="settingsForm">
                    <div class="form-group">
                        <label>اسم المتجر</label>
                        <input type="text" id="setStoreName" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="text" id="setStorePhone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>تكلفة التوصيل (SDG)</label>
                        <input type="number" id="setShippingCost" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>حد التوصيل المجاني (SDG)</label>
                        <input type="number" id="setFreeShippingLimit" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>عن المتجر</label>
                        <textarea id="setAboutUs" class="form-control" rows="4"></textarea>
                    </div>
                </div>
                <button class="add-product-btn" style="width: 100%; margin-top: 20px;" onclick="saveAdminSettings()">
                    <i class="fas fa-save"></i> حفظ الإعدادات
                </button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="admin-modal">
        <div class="modal-content">
            <h3 id="productModalTitle">إضافة منتج جديد</h3>
            <form id="productForm" onsubmit="event.preventDefault(); saveProductData();">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label>اسم المنتج</label>
                    <input type="text" id="prodName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>السعر (SDG)</label>
                    <input type="number" id="prodPrice" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>الفئة</label>
                    <select id="prodCategory" class="form-control">
                        <option value="عطور">عطور</option>
                        <option value="مكياج">مكياج</option>
                        <option value="عناية">عناية</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>المخزون</label>
                    <input type="number" id="prodStock" class="form-control" value="0">
                </div>
                <div class="form-group">
                    <label>الحالة</label>
                    <select id="prodStatus" class="form-control">
                        <option value="true">نشط</option>
                        <option value="false">معطل</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>الوصف</label>
                    <textarea id="prodDesc" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>صورة المنتج</label>
                    <input type="hidden" id="prodImageUrl">
                    <div class="image-preview" id="prodImagePreview" onclick="document.getElementById('prodImageInput').click()">
                        <i class="fas fa-cloud-upload-alt fa-2x"></i>
                        <p>اضغط لرفع صورة</p>
                    </div>
                    <input type="file" id="prodImageInput" style="display: none;" accept="image/*" onchange="handleAdminImageUpload(this)">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="add-product-btn" style="flex: 1;">حفظ</button>
                    <button type="button" class="logout-admin-btn" style="flex: 1; background: #95a5a6;" onclick="closeAdminModal('productModal')">إلغاء</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/security-core.js"></script>
    <script src="js/app-core.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth-system.js"></script>
    <script src="js/admin-core.js"></script>

    <script>
        // تهيئة النظام عند التحميل
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. تهيئة نظام الأمان
                if (window.SecurityCore) window.SecurityCore.init();
                
                // 2. تهيئة Firebase
                const { auth, db, storage } = initializeFirebaseApp();
                window.auth = auth;
                window.db = db;
                window.storage = storage;

                // 3. التحقق من الصلاحيات (حماية الصفحة)
                window.firebaseModules.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const isAdmin = await checkAdminPermissions(user.uid);
                        if (!isAdmin) {
                            alert('عذراً، لا تملك صلاحيات الوصول لهذه الصفحة');
                            window.location.href = 'index.html';
                        } else {
                            // تهيئة لوحة التحكم إذا كان مديراً
                            initAdminPanel();
                        }
                    } else {
                        window.location.href = 'index.html';
                    }
                });

                // 4. إعداد التبويبات
                setupAdminTabs();

            } catch (error) {
                console.error('Initialization Error:', error);
            }
        });

        function handleLogout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                window.firebaseModules.signOut(window.auth).then(() => {
                    window.location.href = 'index.html';
                });
            }
        }

        function closeAdminModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        // ربط الدوال بـ window لتكون متاحة من HTML
        window.openProductModal = openProductModal;
        window.saveProductData = saveProductData;
        window.handleAdminImageUpload = handleAdminImageUpload;
        window.deleteProduct = deleteProduct;
        window.updateOrderStatus = updateOrderStatus;
        window.loadAdminOrders = loadAdminOrders;
        window.viewOrderDetails = viewOrderDetails;
        window.toggleAdminRole = toggleAdminRole;
        window.saveAdminSettings = saveAdminSettings;
    </script>
    
    <!-- Order Details Modal -->
    <div id="orderDetailsModal" class="admin-modal">
        <div class="modal-content">
            <h3>تفاصيل الطلب</h3>
            <div id="orderDetailsBody">
                <!-- JS content -->
            </div>
            <button class="logout-admin-btn" style="width: 100%; margin-top: 20px; background: #95a5a6;" onclick="closeAdminModal('orderDetailsModal')">إغلاق</button>
        </div>
    </div>
</body>
</html>
