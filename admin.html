<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم الشاملة - Eleven Store</title>
    
    <!-- Firebase Modular SDK -->
    <script type="module" id="firebase-sdk-module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, collection, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, orderBy, onSnapshot, serverTimestamp, addDoc, increment, limit, startAfter, getCountFromServer } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
        window.firebaseModules = {
            initializeApp, getAuth, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence,
            getFirestore, doc, collection, getDoc, getDocs, setDoc, updateDoc, deleteDoc, addDoc,
            query, where, orderBy, onSnapshot, serverTimestamp, increment, limit, startAfter, getCountFromServer,
            getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable
        };
        console.log("✅ Firebase Modules Loaded");
        window.dispatchEvent(new CustomEvent('firebase-ready'));
    </script>
    <script src="shared/js/firebase-init.js"></script>
    <script>
        // Middleware متطور للتحقق من الصلاحيات قبل تحميل المحتوى
        (function() {
            // إخفاء المحتوى مبدئياً لمنع الوميض قبل التحقق
            document.write('<style>body { display: none !important; }</style>');

            const verifyAdmin = async () => {
                try {
                    // الانتظار حتى تهيئة Firebase
                    let attempts = 0;
                    while (!window.firebaseInitialized && attempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (!window.firebaseInitialized) {
                        console.error("Firebase failed to initialize in time.");
                        return;
                    }

                    // الاستماع لحالة المصادقة مرة واحدة فقط للتحقق الأولي
                    const { getAuth, onAuthStateChanged } = window.firebaseModules;
                    const auth = getAuth();

                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            console.log("No user session found, redirecting to login...");
                            window.location.href = 'login.html';
                            return;
                        }

                        console.log("User detected, verifying admin status for:", user.email);
                        
                        // التحقق من صلاحيات الأدمن من Firestore مباشرة لضمان الدقة
                        const { doc, getDoc } = window.firebaseModules;
                        const userDoc = await getDoc(doc(window.db, "users", user.uid));
                        
                        if (userDoc.exists() && userDoc.data().isAdmin === true) {
                            console.log("Admin verified. Access granted.");
                            window.isAdmin = true;
                            window.currentUser = user;
                            window.userData = userDoc.data();
                            
                            // إظهار المحتوى الآن
                            document.body.style.setProperty('display', 'block', 'important');
                            
                            // تشغيل دوال التهيئة الخاصة بلوحة التحكم إذا كانت موجودة
                            if (typeof initAdminDashboard === 'function') initAdminDashboard();
                            if (typeof loadStats === 'function') loadStats();
                        } else {
                            console.warn("User is not an admin. Redirecting...");
                            alert('عذراً، ليس لديك صلاحيات دخول لوحة التحكم');
                            window.location.href = 'index.html';
                        }
                    });
                } catch (error) {
                    console.error("Middleware Error:", error);
                    window.location.href = 'login.html';
                }
            };

            window.addEventListener('DOMContentLoaded', verifyAdmin);
        })();
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin/css/admin-styles.css?v=110">
    <link rel="stylesheet" href="shared/css/css-security.css?v=110">
    
    <style>
        .admin-container { max-width: 1400px; }
        .search-filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-filter-bar input, .search-filter-bar select { padding: 10px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-family: 'Cairo'; font-size: 14px; }
        .search-filter-bar input { flex: 1; min-width: 200px; }
        .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .action-buttons button { padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'Cairo'; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        .action-buttons button:hover { background: var(--secondary-color); transform: translateY(-2px); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color); }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        @media (max-width: 768px) { .search-filter-bar, .action-buttons { flex-direction: column; } }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="header-logo">
            <img src="https://i.ibb.co/fVn1SghC/file-00000000cf8071f498fc71b66e09f615.png" alt="Logo">
            <span>لوحة التحكم الشاملة</span>
        </div>
        <div class="header-actions">
            <button class="admin-tab" onclick="window.location.href='index.html'"><i class="fas fa-external-link-alt"></i> عرض المتجر</button>
            <button onclick="logoutAdmin()" class="logout-admin-btn"><i class="fas fa-sign-out-alt"></i> خروج</button>
        </div>
    </header>

    <div class="admin-container">
        <div class="admin-tabs">
            <button class="admin-tab active" data-tab="dashboard" onclick="switchTab('dashboard')"><i class="fas fa-chart-line"></i> الإحصائيات</button>
            <button class="admin-tab" data-tab="products" onclick="switchTab('products')"><i class="fas fa-box"></i> المنتجات</button>
            <button class="admin-tab" data-tab="categories" onclick="switchTab('categories')"><i class="fas fa-list"></i> الفئات</button>
            <button class="admin-tab" data-tab="orders" onclick="switchTab('orders')"><i class="fas fa-shopping-cart"></i> الطلبات</button>
            <button class="admin-tab" data-tab="users" onclick="switchTab('users')"><i class="fas fa-users"></i> المستخدمين</button>
            <button class="admin-tab" data-tab="messages" onclick="switchTab('messages')"><i class="fas fa-envelope"></i> الرسائل</button>
            <button class="admin-tab" data-tab="settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> الإعدادات</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="admin-tab-content active">
            <h2 class="section-title"><i class="fas fa-chart-line"></i> الإحصائيات</h2>
            <div class="admin-stats">
                <div class="admin-stat-card"><div class="stat-icon users"><i class="fas fa-users"></i></div><div class="stat-details"><h3 id="totalUsers">0</h3><p>المستخدمين</p></div></div>
                <div class="admin-stat-card"><div class="stat-icon products"><i class="fas fa-box"></i></div><div class="stat-details"><h3 id="totalProducts">0</h3><p>المنتجات</p></div></div>
                <div class="admin-stat-card"><div class="stat-icon orders"><i class="fas fa-shopping-cart"></i></div><div class="stat-details"><h3 id="totalOrders">0</h3><p>الطلبات</p></div></div>
                <div class="admin-stat-card"><div class="stat-icon sales"><i class="fas fa-dollar-sign"></i></div><div class="stat-details"><h3 id="totalRevenue">0 SDG</h3><p>الإيرادات</p></div></div>
            </div>
        </div>

        <!-- Products -->
        <div id="products" class="admin-tab-content">
            <h2 class="section-title"><i class="fas fa-box"></i> إدارة المنتجات</h2>
            <div class="action-buttons">
                <button onclick="openProductModal()"><i class="fas fa-plus"></i> منتج جديد</button>
                <button onclick="resetProductsFilter()" style="background: var(--secondary-color);"><i class="fas fa-redo"></i> إعادة تعيين</button>
            </div>
            <div class="search-filter-bar">
                <input type="text" id="productsSearchInput" placeholder="ابحث عن منتج..." onkeyup="if(event.key === 'Enter') applyProductsFilter()">
                <select id="productsCategoryFilter" onchange="applyProductsFilter()"><option value="">جميع الفئات</option></select>
                <select id="productsStatusFilter" onchange="applyProductsFilter()"><option value="">الحالة</option><option value="active">نشط</option><option value="inactive">معطل</option></select>
                <button onclick="applyProductsFilter()"><i class="fas fa-search"></i></button>
            </div>
            <div class="admin-card">
                <div class="table-responsive">
                    <table id="productsTable">
                        <thead><tr><th>الصورة</th><th>الاسم</th><th>الفئة</th><th>السعر</th><th>المخزون</th><th>الحالة</th><th>الإجراءات</th></tr></thead>
                        <tbody id="productsBody"><tr><td colspan="7" style="text-align:center;padding:40px;">جاري التحميل...</td></tr></tbody>
                    </table>
                    <div id="productsScrollSentinel" style="height:20px;"></div>
                </div>
            </div>
        </div>

        <!-- Categories -->
        <div id="categories" class="admin-tab-content">
            <h2 class="section-title"><i class="fas fa-list"></i> إدارة الفئات</h2>
            <div class="action-buttons"><button onclick="openCategoryModal()"><i class="fas fa-plus"></i> فئة جديدة</button></div>
            <div class="grid-items" id="categoriesGrid"></div>
        </div>

        <!-- Orders -->
        <div id="orders" class="admin-tab-content">
            <h2 class="section-title"><i class="fas fa-shopping-cart"></i> إدارة الطلبات</h2>
            <div class="action-buttons"><button onclick="resetOrdersFilter()" style="background: var(--secondary-color);"><i class="fas fa-redo"></i> إعادة تعيين</button></div>
            <div class="search-filter-bar">
                <input type="text" id="ordersSearchInput" placeholder="رقم الطلب أو الهاتف..." onkeyup="if(event.key === 'Enter') applyOrdersFilter()">
                <select id="ordersStatusFilter" onchange="applyOrdersFilter()">
                    <option value="">جميع الحالات</option>
                    <option value="pending">قيد الانتظار</option>
                    <option value="processing">جاري التجهيز</option>
                    <option value="shipped">تم الشحن</option>
                    <option value="delivered">تم التوصيل</option>
                    <option value="cancelled">ملغي</option>
                </select>
                <button onclick="applyOrdersFilter()"><i class="fas fa-search"></i></button>
            </div>
            <div class="admin-card">
                <div class="table-responsive">
                    <table id="ordersTable">
                        <thead><tr><th>رقم الطلب</th><th>العميل</th><th>الهاتف</th><th>الإجمالي</th><th>الحالة</th><th>التاريخ</th><th>الإجراءات</th></tr></thead>
                        <tbody id="ordersBody"><tr><td colspan="7" style="text-align:center;padding:40px;">جاري التحميل...</td></tr></tbody>
                    </table>
                    <div id="ordersScrollSentinel" style="height:20px;"></div>
                </div>
            </div>
        </div>

        <!-- Users -->
        <div id="users" class="admin-tab-content">
            <h2 class="section-title"><i class="fas fa-users"></i> إدارة المستخدمين</h2>
            <div class="action-buttons"><button onclick="resetUsersFilter()" style="background: var(--secondary-color);"><i class="fas fa-redo"></i> إعادة تعيين</button></div>
            <div class="search-filter-bar">
                <input type="text" id="usersSearchInput" placeholder="الاسم أو البريد..." onkeyup="if(event.key === 'Enter') applyUsersFilter()">
                <select id="usersStatusFilter" onchange="applyUsersFilter()"><option value="">الحالة</option><option value="active">نشط</option><option value="inactive">معطل</option></select>
                <button onclick="applyUsersFilter()"><i class="fas fa-search"></i></button>
            </div>
            <div class="admin-card">
                <div class="table-responsive">
                    <table id="usersTable">
                        <thead><tr><th>الاسم</th><th>البريد</th><th>الهاتف</th><th>الطلبات</th><th>الإنفاق</th><th>الحالة</th><th>التاريخ</th><th>الإجراءات</th></tr></thead>
                        <tbody id="usersBody"><tr><td colspan="8" style="text-align:center;padding:40px;">جاري التحميل...</td></tr></tbody>
                    </table>
                    <div id="usersScrollSentinel" style="height:20px;"></div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="admin-tab-content">
            <h2 class="section-title"><i class="fas fa-envelope"></i> رسائل العملاء</h2>
            <div class="admin-card">
                <div class="table-responsive">
                    <table id="messagesTable">
                        <thead><tr><th>الاسم</th><th>البريد</th><th>الموضوع</th><th>الحالة</th><th>التاريخ</th><th>الإجراءات</th></tr></thead>
                        <tbody id="messagesBody"><tr><td colspan="6" style="text-align:center;padding:40px;">جاري التحميل...</td></tr></tbody>
                    </table>
                    <div id="messagesScrollSentinel" style="height:20px;"></div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings" class="admin-tab-content">
            <h2 class="section-title"><i class="fas fa-cog"></i> إعدادات المتجر</h2>
            <div class="admin-card">
                <form id="settingsForm" onsubmit="saveSettings(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group"><label>اسم المتجر *</label><input type="text" id="storeName" required></div>
                        <div class="form-group"><label>البريد الإلكتروني *</label><input type="email" id="storeEmail" required></div>
                        <div class="form-group"><label>رقم الهاتف *</label><input type="tel" id="storePhone" required></div>
                        <div class="form-group"><label>العملة</label><input type="text" id="storeCurrency" placeholder="SDG"></div>
                        <div class="form-group" style="grid-column: span 2;"><label>وصف المتجر</label><textarea id="storeDescription" rows="2"></textarea></div>
                    </div>

                    <h3 style="margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 2px solid #eee;"><i class="fas fa-truck"></i> إعدادات الشحن والدفع</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group"><label>تكلفة الشحن (SDG)</label><input type="number" id="shippingCost"></div>
                        <div class="form-group"><label>حد الشحن المجاني (SDG)</label><input type="number" id="freeShippingLimit"></div>
                        <div class="form-group"><label>اسم البنك</label><input type="text" id="bankName"></div>
                        <div class="form-group"><label>رقم الحساب</label><input type="text" id="bankAccount"></div>
                    </div>

                    <h3 style="margin: 30px 0 20px; padding-bottom: 10px; border-bottom: 2px solid #eee;"><i class="fas fa-share-alt"></i> التواصل والألوان</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group"><label>فيسبوك</label><input type="url" id="facebook"></div>
                        <div class="form-group"><label>إنستغرام</label><input type="url" id="instagram"></div>
                        <div class="form-group"><label>واتساب</label><input type="tel" id="whatsapp"></div>
                        <div class="form-group"><label>اللون الأساسي</label><input type="color" id="primaryColor" style="height:45px;"></div>
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top:20px; padding:12px 30px;"><i class="fas fa-save"></i> حفظ الإعدادات</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="admin/js/firebase-config.js?v=110"></script>
    <script src="admin/js/admin-utils.js?v=110"></script>
    <script src="admin/js/sections/stats.js?v=110"></script>
    <script src="admin/js/sections/products.js?v=110"></script>
    <script src="admin/js/sections/orders.js?v=110"></script>
    <script src="admin/js/sections/users.js?v=110"></script>
    <script src="admin/js/sections/coupons.js?v=110"></script>
    <script src="admin/js/sections/messages.js?v=110"></script>
    <script src="admin/js/sections/settings.js?v=110"></script>
    <script src="admin/js/admin-new-core.js?v=110"></script>
</body>
</html>
