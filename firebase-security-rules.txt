// Firebase Firestore Security Rules
// انسخ هذا الكود وضعه في قسم Rules في Firebase Console الخاص بـ Firestore

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // دالة للتحقق مما إذا كان المستخدم مسؤولاً (Admin)
    function isAdmin() {
      return request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true || 
         request.auth.token.email == "yxr.249@gmail.com");
    }

    // قواعد مجموعة الإعدادات (Settings)
    match /settings/{document} {
      allow read: if true; // الجميع يمكنهم قراءة الإعدادات (مثل اسم المتجر، تكلفة الشحن)
      allow write: if isAdmin(); // المسؤول فقط يمكنه تعديل الإعدادات
    }

    // قواعد مجموعة المنتجات (Products)
    match /products/{document} {
      allow read: if true; // الجميع يمكنهم رؤية المنتجات
      allow write: if isAdmin(); // المسؤول فقط يمكنه إضافة أو تعديل أو حذف المنتجات
    }

    // قواعد مجموعة المستخدمين (Users)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId; // المستخدم يمكنه الوصول لبياناته فقط
      allow read, write: if isAdmin(); // المسؤول يمكنه الوصول لجميع بيانات المستخدمين
    }

    // قواعد مجموعة الطلبات (Orders)
    match /orders/{orderId} {
      allow create: if true; // السماح بإنشاء طلبات (حتى للضيوف)
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin()); // المستخدم يرى طلباته فقط، والمسؤول يرى الكل
      allow update, delete: if isAdmin(); // المسؤول فقط يمكنه تحديث حالة الطلب أو حذفه
    }
  }
}

// ---------------------------------------------------------

// Firebase Storage Security Rules
// انسخ هذا الكود وضعه في قسم Rules في Firebase Console الخاص بـ Storage

rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // دالة للتحقق من المسؤول
    function isAdmin() {
      return request.auth != null && request.auth.token.email == "yxr.249@gmail.com";
    }

    // قواعد صور المنتجات
    match /products/{allPaths=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // قواعد إيصالات الدفع
    match /receipts/{userId}/{allPaths=**} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow write: if true; // السماح برفع الإيصالات (يمكن تقييدها بـ request.auth != null إذا كان التسجيل إجبارياً)
    }
  }
}
